<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ö–∞—Ä—Ç–∞ –≤–æ–∑–¥—É—à–Ω–æ–π —Ç—Ä–µ–≤–æ–≥–∏</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body {
  margin: 0;
  height: 100%;
  font-family: Arial, sans-serif;
}
#map {
  height: 100%;
}
#adminBtn {
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1000;
  padding: 10px 14px;
  font-size: 16px;
}
#panel {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: #fff;
  border-top: 2px solid #000;
  padding: 10px;
  display: none;
  z-index: 1000;
}
.region {
  display: inline-block;
  margin: 5px;
}
select, button {
  font-size: 14px;
}
.status {
  font-size: 14px;
  margin-top: 4px;
}
</style>
</head>

<body>

<button id="adminBtn">–ê–¥–º–∏–Ω</button>

<div id="panel">
  <b>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</b><br><br>
  –°—Ç–∞—Ç—É—Å –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏:
  <select id="statusSelect">
    <option value="none">‚ö™ –û—Ç–±–æ–π</option>
    <option value="warning">üü° –£–≥—Ä–æ–∑–∞</option>
    <option value="alert">üî¥ –¢—Ä–µ–≤–æ–≥–∞</option>
  </select>
  <button onclick="saveStatus()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const PASSWORD = "3709";

const map = L.map('map').setView([49, 32], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 8
}).addTo(map);

// –¶–≤–µ—Ç–∞
function getColor(type) {
  if (type === 'alert') return 'red';
  if (type === 'warning') return 'yellow';
  return '#ccc';
}

// –°–æ—Å—Ç–æ—è–Ω–∏—è
let data = JSON.parse(localStorage.getItem("alerts") || "{}");
let selectedLayer = null;

// –í—Ä–µ–º—è –ú–°–ö
function nowMSK() {
  return new Date(new Date().getTime() + 3*60*60*1000);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ GeoJSON –£–∫—Ä–∞–∏–Ω—ã
fetch("https://raw.githubusercontent.com/datasets/geo-admin1-us/master/data/ukraine.geojson")
.then(r => r.json())
.then(geo => {
  L.geoJSON(geo, {
    style: f => {
      const s = data[f.properties.name];
      return {
        color: "#000",
        weight: 1,
        fillColor: s ? getColor(s.type) : "#ccc",
        fillOpacity: 0.6
      };
    },
    onEachFeature: (f, layer) => {
      layer.on("click", () => {
        selectedLayer = layer;
        selectedLayer.featureName = f.properties.name;
      });

      if (data[f.properties.name]) {
        updatePopup(layer, f.properties.name);
      }
    }
  }).addTo(map);
});

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ popup
function updatePopup(layer, name) {
  const s = data[name];
  if (!s) return;

  const start = new Date(s.start);
  const diff = Math.floor((nowMSK() - start)/60000);

  let text = "‚ö™ –û—Ç–±–æ–π";
  if (s.type === "alert") text = "üî¥ –¢—Ä–µ–≤–æ–≥–∞";
  if (s.type === "warning") text = "üü° –£–≥—Ä–æ–∑–∞";

  layer.bindPopup(
    `<b>${name}</b><br>${text}<br>–î–ª–∏—Ç—Å—è: ${diff} –º–∏–Ω`
  );
}

// –ê–¥–º–∏–Ω
document.getElementById("adminBtn").onclick = () => {
  const p = prompt("–ü–∞—Ä–æ–ª—å:");
  if (p === PASSWORD) {
    document.getElementById("panel").style.display = "block";
  } else {
    alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
  }
};

function saveStatus() {
  if (!selectedLayer) {
    alert("–í—ã–±–µ—Ä–∏ –æ–±–ª–∞—Å—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ");
    return;
  }

  const status = document.getElementById("statusSelect").value;
  const name = selectedLayer.featureName;

  if (status === "none") {
    delete data[name];
  } else {
    data[name] = {
      type: status,
      start: nowMSK().toISOString()
    };
  }

  localStorage.setItem("alerts", JSON.stringify(data));
  location.reload();
}
</script>

</body>
</html>
