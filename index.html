<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ö–∞—Ä—Ç–∞ —Ç—Ä–µ–≤–æ–≥</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  margin: 0;
  background: #e6e6e6;
  font-family: Arial, sans-serif;
}

#top {
  background: #111;
  color: #fff;
  padding: 10px;
  display: flex;
  justify-content: space-between;
}

#mapBox {
  width: 90%;
  max-width: 900px;
  margin: 12px auto;
  border: 3px solid #000;
}

#map {
  height: 420px;
}

#panel {
  display: none;
  width: 90%;
  max-width: 900px;
  margin: 10px auto;
  background: #fff;
  border: 2px solid #000;
  padding: 10px;
}

button, select, input {
  padding: 6px;
  margin-top: 6px;
}

#info {
  width: 90%;
  max-width: 900px;
  margin: auto;
  font-size: 14px;
}
</style>
</head>

<body>

<div id="top">
  <div>üïí –ú–°–ö: <span id="time"></span></div>
  <button id="adminBtn">–ê–¥–º–∏–Ω</button>
</div>

<div id="mapBox">
  <div id="map"></div>
</div>

<div id="info"></div>

<div id="panel">
  <b>–û–±–ª–∞—Å—Ç—å:</b> <span id="regionName">‚Äî</span><br>

  <select id="status">
    <option value="none">‚ö™ –û—Ç–±–æ–π</option>
    <option value="warning">üü° –£–≥—Ä–æ–∑–∞</option>
    <option value="alert">üî¥ –¢—Ä–µ–≤–æ–≥–∞</option>
  </select>
  <br>
  <button onclick="saveRegion()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>

  <hr>

  <b>–í–∏–∑—É–∞–ª—å–Ω—ã–π –æ–±—ä–µ–∫—Ç</b><br>
  –ù–∞–∑–≤–∞–Ω–∏–µ: <input id="objName"><br>
  –í—ã–ª–µ—Ç (lat,lng): <input id="from"><br>
  –ü—Ä–∏–±—ã—Ç–∏–µ (lat,lng): <input id="to"><br>
  –í—Ä–µ–º—è –ø–æ–ª—ë—Ç–∞ (–º–∏–Ω): <input type="number" id="flight" value="5"><br>
  <button onclick="addObject()">–ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const PASSWORD = "3709";
const map = L.map("map").setView([49,32],6);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

// ===== –í–†–ï–ú–Ø –ú–°–ö =====
function tick(){
  const d = new Date(Date.now()+3*3600000);
  time.textContent=d.toISOString().slice(11,19);
}
setInterval(tick,1000); tick();

// ===== –î–ê–ù–ù–´–ï =====
let regions = JSON.parse(localStorage.getItem("regions")||"{}");
let selectedName=null, selectedLayer=null;

function color(s){
  return s==="alert"?"#f00":s==="warning"?"#ff0":"#ccc";
}

// ===== –ö–ê–†–¢–ê =====
fetch("https://raw.githubusercontent.com/deldersveld/topojson/master/countries/ukraine/ukraine-oblasts.json")
.then(r=>r.json())
.then(data=>{
  L.geoJSON(data,{
    style:f=>{
      const n=f.properties.name;
      return {
        fillColor: color(regions[n]?.status),
        fillOpacity:0.6,
        color:"#333",
        weight:1
      }
    },
    onEachFeature:(f,l)=>{
      l.on("click",()=>{
        selectedName=f.properties.name;
        selectedLayer=l;
        regionName.textContent=selectedName;
      });
    }
  }).addTo(map);
});

// ===== –°–û–•–†–ê–ù–ò–¢–¨ –û–ë–õ–ê–°–¢–¨ =====
function saveRegion(){
  if(!selectedName)return;
  const s=status.value;
  regions[selectedName]={status:s,start:s==="alert"?Date.now():null};
  localStorage.setItem("regions",JSON.stringify(regions));
  selectedLayer.setStyle({fillColor:color(s)});
  updateInfo();
}

// ===== –ò–ù–§–û =====
function updateInfo(){
  info.innerHTML="";
  const now=Date.now();
  for(const [n,d] of Object.entries(regions)){
    if(d.status==="alert"){
      info.innerHTML+=`üî¥ ${n}: ${Math.floor((now-d.start)/60000)} –º–∏–Ω<br>`;
    }
    if(d.status==="warning"){
      info.innerHTML+=`üü° ${n}: —É–≥—Ä–æ–∑–∞<br>`;
    }
  }
}
setInterval(updateInfo,60000); updateInfo();

// ===== –û–ë–™–ï–ö–¢ =====
function addObject(){
  const f=from.value.split(",").map(Number);
  const t=to.value.split(",").map(Number);
  const mins=+flight.value;
  const start=Date.now();

  const line=L.polyline([f,t],{color:"#000"}).addTo(map);
  const m=L.marker(f).addTo(map);

  const int=setInterval(()=>{
    const p=(Date.now()-start)/(mins*60000);
    if(p>=1){
      m.setLatLng(t);
      clearInterval(int);
      const boom=L.marker(t,{icon:L.divIcon({html:"üí•",iconSize:[30,30]})}).addTo(map);
      setTimeout(()=>map.removeLayer(boom),60000);
      return;
    }
    m.setLatLng([
      f[0]+(t[0]-f[0])*p,
      f[1]+(t[1]-f[1])*p
    ]);
  },1000);
}

// ===== –ê–î–ú–ò–ù =====
adminBtn.onclick=()=>{
  if(prompt("–ü–∞—Ä–æ–ª—å:")===PASSWORD){
    panel.style.display="block";
  }
};
</script>

</body>
</html>
