<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ö–∞—Ä—Ç–∞ —Ç—Ä–µ–≤–æ–≥ (—Å–∏–º—É–ª—è—Ü–∏—è)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #f2f2f2;
}
#top {
  padding: 10px;
  background: #111;
  color: #fff;
  display: flex;
  justify-content: space-between;
}
#mapWrap {
  margin: 10px;
  border: 3px solid #000;
}
#map {
  height: 70vh;
}
#adminBtn {
  padding: 6px 12px;
}
#panel {
  display: none;
  padding: 10px;
  background: #fff;
  border-top: 2px solid #000;
}
input, select, button {
  margin: 4px 0;
}
</style>
</head>

<body>

<div id="top">
  <div>üïí –ú–°–ö: <span id="time"></span></div>
  <button id="adminBtn">–ê–¥–º–∏–Ω</button>
</div>

<div id="mapWrap">
  <div id="map"></div>
</div>

<div id="panel">
  <h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3>

  <b>–û–±–ª–∞—Å—Ç–∏</b><br>
  –°—Ç–∞—Ç—É—Å:
  <select id="regionStatus">
    <option value="none">‚ö™ –û—Ç–±–æ–π</option>
    <option value="warning">üü° –£–≥—Ä–æ–∑–∞</option>
    <option value="alert">üî¥ –¢—Ä–µ–≤–æ–≥–∞</option>
  </select>
  <button onclick="saveRegion()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–ª–∞—Å—Ç—å</button>

  <hr>

  <b>–ú–∞—Ä—à—Ä—É—Ç (–≤–∏–∑—É–∞–ª—å–Ω–æ)</b><br>
  –ù–∞–∑–≤–∞–Ω–∏–µ:
  <input id="routeName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ"><br>
  –°—Ç–∞—Ä—Ç (–ú–°–ö):
  <input type="datetime-local" id="startTime"><br>
  –§–∏–Ω–∏—à (–ú–°–ö):
  <input type="datetime-local" id="endTime"><br>
  <button onclick="startRoute()">–°–æ–∑–¥–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const PASSWORD = "3709";
const map = L.map('map').setView([49, 32], 6);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

// –≤—Ä–µ–º—è –ú–°–ö
function updateTime() {
  const d = new Date(Date.now() + 3*3600*1000);
  document.getElementById("time").textContent =
    d.toISOString().slice(11,19);
}
setInterval(updateTime, 1000);
updateTime();

// –¥–∞–Ω–Ω—ã–µ
let regions = JSON.parse(localStorage.getItem("regions") || "{}");
let routes = JSON.parse(localStorage.getItem("routes") || "[]");

let selectedRegion = null;
let clickPoints = [];

// —Ü–≤–µ—Ç–∞
function color(type) {
  if (type === "alert") return "red";
  if (type === "warning") return "yellow";
  return "#ccc";
}

// —Ä–µ–≥–∏–æ–Ω—ã
fetch("https://raw.githubusercontent.com/datasets/geo-admin1-us/master/data/ukraine.geojson")
.then(r => r.json())
.then(g => {
  L.geoJSON(g, {
    style: f => ({
      color:"#000",
      weight:1,
      fillOpacity:0.6,
      fillColor: color(regions[f.properties.name])
    }),
    onEachFeature: (f, l) => {
      l.on("click", () => selectedRegion = f.properties.name);
    }
  }).addTo(map);
});

// –∞–¥–º–∏–Ω
document.getElementById("adminBtn").onclick = () => {
  if (prompt("–ü–∞—Ä–æ–ª—å:") === PASSWORD)
    document.getElementById("panel").style.display = "block";
};

// —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±–ª–∞—Å—Ç—å
function saveRegion() {
  if (!selectedRegion) return alert("–ö–ª–∏–∫–Ω–∏ –æ–±–ª–∞—Å—Ç—å");
  const s = document.getElementById("regionStatus").value;
  if (s === "none") delete regions[selectedRegion];
  else regions[selectedRegion] = s;
  localStorage.setItem("regions", JSON.stringify(regions));
  location.reload();
}

// –º–∞—Ä—à—Ä—É—Ç—ã
map.on("click", e => {
  if (document.getElementById("panel").style.display !== "block") return;
  clickPoints.push(e.latlng);
});

function startRoute() {
  if (clickPoints.length < 2) return alert("–ö–ª–∏–∫–Ω–∏ —Å—Ç–∞—Ä—Ç –∏ —Ñ–∏–Ω–∏—à");
  routes.push({
    name: routeName.value,
    from: clickPoints[0],
    to: clickPoints[1],
    start: new Date(startTime.value).getTime(),
    end: new Date(endTime.value).getTime(),
    done:false
  });
  localStorage.setItem("routes", JSON.stringify(routes));
  location.reload();
}

// –∞–Ω–∏–º–∞—Ü–∏—è
routes.forEach(r => {
  const line = L.polyline([r.from, r.to]).addTo(map);
  const marker = L.circleMarker(r.from, {radius:6}).addTo(map);

  const interval = setInterval(() => {
    const now = Date.now() + 3*3600*1000;
    if (now < r.start) return;

    const p = Math.min(1, (now - r.start) / (r.end - r.start));
    const lat = r.from.lat + (r.to.lat - r.from.lat)*p;
    const lng = r.from.lng + (r.to.lng - r.from.lng)*p;
    marker.setLatLng([lat,lng]);

    if (p >= 1) {
      clearInterval(interval);
      const boom = L.marker(r.to, {
        icon: L.divIcon({html:"üí•", className:""})
      }).addTo(map);
      setTimeout(()=>map.removeLayer(boom),60000);
    }
  },1000);
});
</script>

</body>
</html>
