<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ö–∞—Ä—Ç–∞ –≤–æ–∑–¥—É—à–Ω—ã—Ö —Ç—Ä–µ–≤–æ–≥</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: #e5e5e5;
}

#top {
  background: #111;
  color: #fff;
  padding: 10px 14px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#adminBtn {
  padding: 6px 12px;
  cursor: pointer;
}

#mapBox {
  width: 95%;
  max-width: 900px;
  margin: 15px auto;
  border: 3px solid #000;
  background: #000;
}

#map {
  height: 420px;
}

#panel {
  display: none;
  width: 95%;
  max-width: 900px;
  margin: 10px auto;
  background: #fff;
  border: 2px solid #000;
  padding: 10px;
}

#statusText {
  width: 95%;
  max-width: 900px;
  margin: 0 auto 10px;
  font-size: 14px;
}

select, button {
  padding: 6px;
  margin-top: 6px;
}
</style>
</head>

<body>

<div id="top">
  <div>üïí –ú–°–ö: <span id="time"></span></div>
  <button id="adminBtn">–ê–¥–º–∏–Ω</button>
</div>

<div id="mapBox">
  <div id="map"></div>
</div>

<div id="statusText"></div>

<div id="panel">
  <b>–í—ã–±—Ä–∞–Ω–Ω–∞—è –æ–±–ª–∞—Å—Ç—å:</b> <span id="regionName">‚Äî</span><br>

  <select id="statusSelect">
    <option value="none">‚ö™ –û—Ç–±–æ–π</option>
    <option value="warning">üü° –£–≥—Ä–æ–∑–∞</option>
    <option value="alert">üî¥ –í–æ–∑–¥—É—à–Ω–∞—è —Ç—Ä–µ–≤–æ–≥–∞</option>
  </select>
  <br>
  <button onclick="saveStatus()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const PASSWORD = "3709";

const map = L.map("map", {
  zoomControl: true
}).setView([49, 32], 6);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  minZoom: 5,
  maxZoom: 10
}).addTo(map);

// ===== –í–†–ï–ú–Ø –ú–°–ö =====
function updateTime() {
  const d = new Date(Date.now() + 3 * 3600 * 1000);
  document.getElementById("time").textContent =
    d.toISOString().slice(11, 19);
}
setInterval(updateTime, 1000);
updateTime();

// ===== –î–ê–ù–ù–´–ï =====
let regionsData = JSON.parse(localStorage.getItem("regions") || "{}");
let selectedLayer = null;
let selectedName = null;

// ===== –¶–í–ï–¢ =====
function colorByStatus(s) {
  if (s === "alert") return "#ff0000";
  if (s === "warning") return "#ffcc00";
  return "#cccccc";
}

// ===== –ö–ê–†–¢–ê –£–ö–†–ê–ò–ù–´ =====
fetch("https://raw.githubusercontent.com/deldersveld/topojson/master/countries/ukraine/ukraine-oblasts.json")
.then(r => r.json())
.then(data => {
  L.geoJSON(data, {
    style: f => {
      const name = f.properties.name;
      const st = regionsData[name]?.status || "none";
      return {
        color: "#333",
        weight: 1,
        fillColor: colorByStatus(st),
        fillOpacity: 0.6
      };
    },
    onEachFeature: (f, layer) => {
      layer.on("click", () => selectRegion(f.properties.name, layer));
    }
  }).addTo(map);
  updateStatusText();
});

// ===== –í–´–ë–û–† –û–ë–õ–ê–°–¢–ò =====
function selectRegion(name, layer) {
  selectedLayer = layer;
  selectedName = name;
  document.getElementById("regionName").textContent = name;
}

// ===== –°–û–•–†–ê–ù–ï–ù–ò–ï =====
function saveStatus() {
  if (!selectedName) return;

  const status = document.getElementById("statusSelect").value;

  if (status === "alert") {
    regionsData[selectedName] = {
      status,
      start: Date.now()
    };
  } else {
    regionsData[selectedName] = { status };
  }

  localStorage.setItem("regions", JSON.stringify(regionsData));
  location.reload();
}

// ===== –¢–ï–ö–°–¢ –°–¢–ê–¢–£–°–ê =====
function updateStatusText() {
  const box = document.getElementById("statusText");
  box.innerHTML = "";

  const now = Date.now();

  for (const [name, d] of Object.entries(regionsData)) {
    if (d.status === "alert") {
      const minutes = Math.floor((now - d.start) / 60000);
      box.innerHTML += `üî¥ ${name}: —Ç—Ä–µ–≤–æ–≥–∞ —É–∂–µ ${minutes} –º–∏–Ω<br>`;
    }
    if (d.status === "warning") {
      box.innerHTML += `üü° ${name}: —É–≥—Ä–æ–∑–∞ –≤–æ–∑–¥—É—à–Ω–æ–π —Ç—Ä–µ–≤–æ–≥–∏<br>`;
    }
  }
}
setInterval(updateStatusText, 60000);
updateStatusText();

// ===== –ê–î–ú–ò–ù =====
document.getElementById("adminBtn").onclick = () => {
  const p = prompt("–ü–∞—Ä–æ–ª—å:");
  if (p === PASSWORD) {
    document.getElementById("panel").style.display = "block";
  }
};
</script>

</body>
</html>
